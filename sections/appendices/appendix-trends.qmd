---
author: David Carslaw
---

# 趋势分析进阶 {#sec-trends-gam}

理解趋势变化是空气质量分析甚至大气科学的核心组成部分。[openair]{.pkg}提供了`smoothTrend`和`TheilSen`两个函数用于趋势分析（参见@sec-smoothTrend 和 @sec-TheilSen ），其中后者对线性的趋势分析非常有用。对趋势进行严肃的定量并不是一件容易的事情，需要对每一个时间序列进行单独的考量并且进行完整充分的诊断。在这一节中，我们利用R语言在统计计算方面的优势来进行拟合趋势分析。多年大气成份数据分析的经验告诉我们，现实中的趋势很少是线性的。这多少有点儿让人沮丧，因为不得不放弃那些围绕线性模型建立的统计方法。

广义加法模型（GAM）提供了一种灵活的趋势计算方法，[mgcv]{.pkg} 包专门用于此类建模，详细信息可以参见 @Wood2006 和 [mgcv]{.pkg} 包本身的文档。

这里我们使用爱尔兰西海岸梅斯角站点历时23年的 O~3~ 监测数据作为示例，演示建立模型来回答趋势问题所需要的主要步骤。导入数据后，我们增加year、month和`trend`数据列。这里`trend`是构建解释模型所需要的简单代表每月的十进制日期。

首先，导入数据：

```{r}
#| echo: false
#| message: false
#| warning: false
#| cache: false
library(mgcv)
library(openair) # load openair
load("../../assets/data/MaceHead.RData")
```

```{r}
#| eval: false
library(mgcv)
dat <- importUKAQ(site = "mh", year = 1988:2010)
```

```{r}
#| label: calcMonthly
## calculate monthly means
monthly <- timeAverage(dat, avg.time = "month")
## now calculate components for the models
monthly$year <- as.numeric(format(monthly$date, "%Y"))
monthly$month <- as.numeric(format(monthly$date, "%m"))
monthly <- transform(monthly, trend = year + (month - 1) / 12)
```

绘制整体的数据情况*永远*是第一步分析的建议：

```{r}
#| label: fig-MHplot
#| fig-cap: 爱尔兰梅斯角站点 O~3~ 月均浓度变化 (1998--2010)。
#| fig-width: 10
#| fig-height: 5
timePlot(monthly, pollutant = "o3")
```

从@fig-MHplot 中可以看出 O~3~ 浓度呈现明显的季节性变化，这当然是意料之中的，但是这其中是否隐藏着趋势变化就不那么明显了。

在已知数据存在季节性信号的情况下，我们仍然可以先忽略它并构建一个单一的趋势模型（model M0）。

```{r}
#| label: mod1
M0 <- gam(o3 ~ s(trend), data = monthly)
summary(M0)
```

从决定系数adjusted r^2^可以看出，模型只能够解释大约2%的变异。造成这个问题的原因是没有考虑数据当中的季节性变化因素。我们可以通过残差的自相关函数（ACF）来观察上述缺失因素所带来的影响，见 @fig-M0ACF ，可以看到残差带有很强的季节性特征。 @Chatfield2004 中介绍了有关数据序列数据建模的大量信息。

```{r}
#| label: fig-M0ACF
#| fig-cap: M0模型中残差的自相关函数（ACF）。
#| fig-width: 5
#| fig-height: 4
#| out-width: 70%
acf(residuals(M0))
```

下面我们通过在拟合方程中加入一个描述O~3~浓度季节变化的自变量来优化模型。这里我们选取周期性样条曲线作为基函数（`bs = "cc"`），它会将首尾点连接以来，即12月和1月。

```{r}
#| label: mod1a
M1 <- gam(o3 ~ s(trend) + s(month, bs = "cc"), data = monthly)
summary(M1)
```

现在我们的模型已经大幅提高到可以解释r^2^为0.65的变异，而且趋势和季节变化两个变量的p值都很显著。下面分别看一下两个分量的变化曲线：

```{r}
#| label: fig-M1trend
#| fig-cap: M1模型的趋势分量。
#| fig-width: 5
#| fig-height: 4
#| out-width: 70%
plot.gam(M1, select = 1, shade = TRUE)
```

```{r}
#| label: fig-M1seas
#| fig-cap: M1模型的季节变化分量。
#| fig-width: 5
#| fig-height: 4
#| out-width: 70%
plot.gam(M1, select = 2, shade = TRUE)
```

@fig-M1seas 中的季节性变化分量清晰的显示出该站点 O~3~ 随季节变化的情况（峰值出现在四月）。在这个例子中趋势分量表现为线性，这对本模型来说也是可行的。M1模型已经有了大幅改进，但是从自相关函数图  @fig-M1ACF 中我们仍然可以看到残差中存在短期的自相关性。

注意在对比不同模型时还应考虑做更多的诊断测试，如残差的正态性，在这里不进一步阐述。从@fig-MHplot 中残差的表现看，这个模型似乎无法解释O~3~ 的极低值。这些（导致偏态）的极低值应该与来自欧洲内陆的高污染气团有关。理想的做法是按照不同的气团来源切分数据分别拟合，这也是当初决定在 [openair]{.pkg} 引入后向轨迹的初衷。

```{r}
#| label: fig-M1ACF
#| fig-cap: M1模型中残差的自相关函数（ACF）。
#| fig-width: 5
#| fig-height: 4
#| out-width: 70%
acf(residuals(M1))
```

接下来偏自相关函数（PACF）的应用表明 AR1 模型能够拟合短期的自相关特性。该模型引入广义加法混合模型（gamm）使用线性混合模型来处理数据中短期的自相关。 `gamm` 函数使用[nmle]{.pkg} 包和广义线性混合模型（GLMM）的拟合路径。下面的M2模型中明确定义了相关性架构。

```{r}
#| label: M3mod
M2 <- gamm(o3 ~ s(month, bs = "cc")  + s(trend), 
           data = monthly,
           correlation = corAR1(form = ~ month | year))
summary(M2$gam)
```

新模型ACF图 @fig-M2ACF 中可以看出自相关已经处理完成，我们可以对趋势分量（未绘制）更有信心。请注意，在这种情况下，我们需要使用归一化选项来获得残差拟合的情况。

```{r}
#| label: fig-M2ACF
#| fig-cap: M2模型中残差的自相关函数（ACF）。
#| fig-width: 5
#| fig-height: 4
#| out-width: 70%
acf(residuals(M2$lme, type = "normalized"))
```

模型M2假设趋势和季节变化两个分量是彼此独立变化的。但是如果季节变化的振幅和/或相位随时间变化，那么能够考虑两者之间相互作用的模型可能会更好。事实上这里似乎确实如此，下面使用张量积平滑（`te`）对拟合模型作进一步的改进。由于趋势和季节性分量本质上是不同的时间尺度，因此不使用各向同性平滑（`s`）的方法是有道理的。我们不一定总是希望对两个分量应用相同级别的平滑度，除了一个反例，即纬度和经度。

```{r}
#| label: M3modGAMM
#| cache: false
M3 <- gamm(o3 ~ s(month, bs = "cc")  + 
             te(trend, month), data = monthly,
           correlation = corAR1(form = ~ month | year))
summary(M3$gam)
```

绘制趋势和季节月份之间的双向作用关系有点儿困难，我们可以用@fig-perpsM3 中曲面的形式来表达。从图中可以看到在夏季趋势变化非常小，而在秋冬季，O~3~ 的趋势分量出现了明显的上升。

```{r}
#| label: fig-perpsM3
#| fig-cap: 趋势和季节分量之间的双向作用。
#| fig-width: 7
#| fig-height: 7
#| out-width: 75%
plot(M3$gam, select = 2, scheme = 1, theta = 225, phi = 10,ticktype = "detailed")
```

上面的简短分析涉及了多个分析方法和步骤，但是这些步骤也许并不是广泛适用，因为梅斯角站点的数据可能比较特殊。城市地区站点的典型数据在考虑了季节性特征之后大部分不会再出现明显的残差自相关，从而避免了考虑相关性结构带来的复杂性。也许对于梅斯角这一位置，以及这一位置上的O~3~ 这一污染物来说，还受到更大尺度大气过程的影响，是当前这些模型都难以捕捉到的。
