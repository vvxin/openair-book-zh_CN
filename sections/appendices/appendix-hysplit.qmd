---
author: David Carslaw
---

# HYSPLIT轨迹数据生成 {#sec-prod-hyspl-traj}

在 @sec-trajPlot 中我们使用 [openair]{.pkg} 导入了伦敦一整年的计算好的轨迹数据进行分析。这些数据为3小时间隔的96小时后向轨迹，存储在Ricardo公司的服务器上。一些用户反馈希望能够得到定制的HYSPLIT模型结果，比如不同的轨迹初始高度或是其它地点的。这里必须要说的是HYSPLIT是一个功能强大并且可以灵活定制的模型，为了重复发挥其潜力，得到定制结果的最好方法肯定是去亲自运行HYSPLIT模型[@stein2015]。

Rich Iannone (见 [这里](https://github.com/rich-iannone/splitr)) 开发了一个很好的R语言包 [splitr]{.pkg}，专门用于适配多种气象数据输入的HYSPLIT轨迹和扩散模型调用及结果可视化。如果用户希望有更多HYSPLIT模型的运行参数的定制空间，特别是针对短时间污染过程做高时间分辨率气象分析的场景，建议使用[splitr]{.pkg} 。

本节我们讨论的场景是使用气象再分析数据作为HTSPLIT模型输入进行长时间空气质量分析。下面的代码假定一次性运行一整年的数据，但是也可以调整为较短时间段。生成轨迹数据需要以下三方面准备工作：

1.  下载和安装 [NOAA HYSPLIT 模型](https://www.ready.noaa.gov/HYSPLIT.php)， 一些地方需要有写入权限（见下文）。

2.  从NOAA网站下载月度的气象数据文件(.gbl) 。

3.  获取HYSPLIT程序代码。

To run back trajectories it is necessary to download the meteorological data files. The easiest way to download the meteorological files is using the function below.
后向轨迹模型的运行需要气象数据作为输入文件。最简单的下载气象数据文件的方法是使用下面的函数。

```{r}
#| label: getMet
#| eval: false
getMet <- function(year = 2013, month = 1,
                   path_met = "~/TrajData/") {
  for (i in seq_along(year)) {
    for (j in seq_along(month)) {
      download.file(
        url = paste0(
          "https://www.ready.noaa.gov/data/archives/reanalysis/RP",
          year[i], sprintf("%02d", month[j]), ".gbl"
        ),
        destfile = paste0(
          path_met, "RP", year[i],
          sprintf("%02d", month[j]), ".gbl"
        ),
        mode = "wb"
      )
    }
  }
}
```

该函数会下载月度气象数据包（每个文件与120M）到指定路径，这些历史数据的下载只是一次性的工作，例如下载2013年全年的数据：

```{r}
#| label: getMet2
#| eval: false
getMet(year = 2013, month = 1:12)
```

下面需要安装[devtools]{.pkg}包来加载*GitHub gist*（一些在线公开共享的代码片段）上的函数。粘贴并运行下面的R语言代码，即可加载完成运行HYSPLIT模型所需要的功能函数。

```{r}
#| label: getGist
library(devtools)
source_gist("https://gist.github.com/davidcarslaw/c67e33a04ff6e1be0cd7357796e4bdf5",
            filename = "run_hysplit.R")
```

完成函数加载后，我们即可使用`run_hysplit`函数来调用HYSPLIT模型了，可以参考 [这里](https://gist.github.com/davidcarslaw/c67e33a04ff6e1be0cd7357796e4bdf5)。

例：

```{r}
#| label: run_hysplit
#| eval: false
data_out <- run_hysplit(
latitude = 36.134, 
 longitude = -5.347, 
  runtime = -96, 
  start_height = 10, 
  model_height = 10000, 
  start = 2015,
  end = "2015-01-10",
  hysplit_exec = "~/hysplit/exec", 
  hysplit_input = "~/trajData", 
  hysplit_output = "~/temp",
  site = "gibraltar")
```

`data_out`可以直接用于[openair]{.pkg} 的后向轨迹函数。上面的代码会同时返回HYSPLIT模型产出的气压、温度、地形和边界层高度等信息。

上面大部分设置都比较好理解，三个路径 `hysplit_exec` 为HYSPLIT可执行文件所在目录，`hysplit_input`为（上面下载的）气象数据所在目录，`hysplit_output`为HYSPLIT临时文件写入目录。

运行完成后建议把生成文件存储为R数据对象：

```{r}
#| label: saveHysplit
#| eval: false
saveRDS(data_out, file = "~/trajProc/myTrajData.rds")
```

存储后的R数据对象很容易读取复用：

```{r}
#| label: importTrajLocal
#| eval: false
traj <- readRDS("~/trajProc/myTrajData.rds")
```
