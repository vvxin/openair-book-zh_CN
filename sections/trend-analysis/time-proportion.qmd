---
author: David Carslaw
---

# Time proportion plots 时序堆叠图 {#sec-timeProp}

## 简介 {#sec-timePropBack}

`timeProp` (time proportion)函数以堆叠柱图的形式来展示时间序列数据，图中每一个单柱表示的是当前时间段内特定变量不同取值的比例，该变量来自数据框中的一个字符型或因子型变量。`polarCluster` (见 @sec-trajCluster-trajectory-analysis) 和 `trajCluster` (见 @sec-trajCluster) 分别对本地影响和区域（后向轨迹）影响进行聚类分析，本功能函数则用于对上述两个函数的结果在时间尺度上做进一步的分析。时间序列的制图需要对数据进行不同时间尺度的聚合，在这里通过 `avg.time` 选项来实现。

时序堆叠图在y轴展示 `pollutant` （通过 `avg.time` 设置进行数据聚合后的）的浓度值。每一个时间区间的浓度柱被分成不同的 `proportion`。所以时序堆叠图展示的在 `pollutant` 总浓度的构成随时间的变化情况。

## 示例 {#sec-timePropEx}

@fig-timeProp 是 `timeProp` 函数的一个应用示例。这个例子是对2003年（通过 `selectByDate` 函数截取）的 SO~2~ 进行不同风向条件下浓度贡献的时间序列分析。全年数据以3天为单位进行平均值处理，每一条数据在绘制柱图的时候使用风向进行分类。其它的参数包括将设置图例放在图的上方，以及设置图例排版的列数。从@fig-timeProp 中可以很明显的看出在几次 SO~2~ 的高污染过程中，东风的贡献都是主导性的，这个特征在全年都是存在的。

```{r}
#| label: fig-timeProp
#| fig-cap: '`timeProp` plot for SO~2~ concentrations in 2003. The data are categorised into 8 wind sectors for 3-day averages.'
#| fig-width: 15
#| fig-height: 4
#| column: screen-inset-right
library(openair) # load the package

timeProp(selectByDate(mydata, year = 2003),
         pollutant = "so2", avg.time = "3 day",
         proportion = "wd", 
         date.breaks = 10, key.position = "top",
         key.columns = 8, ylab = "so2 (ug/m3)")
```

注意，本函数中最重要的 `proportion` 选项通常为数据框中的一列可分类的变量（因子型或字符型）。如果指定为数值型的变量，缺省状况下会按照4个分位数区间对这个变量因子化。下面的例子将使用风速作为分类的因子，这样可以看到不同风速条件对 SO~2~ 高浓度的影响情况，更重要的是，我们可以从时序堆叠图中看到影响所发生的具体时间点。

@fig-timePropw 是用 `timeProp` 分类堆叠一个连续数值变量的示例。这里使用 `n.levels` 选项将风速划分为3个分位区间。通过这种方法，任何数值型的变量都可以作为分类的对象。

```{r}
#| label: fig-timePropws
#| fig-cap: '`timeProp` plot for SO~2~ concentrations in 2003. The data are categorised into 4 wind speed categories for 3-day averages.'
#| fig-width: 15
#| fig-height: 4
#| column: screen-inset-right
timeProp(selectByDate(mydata, year = 2003),
         pollutant = "so2",
         avg.time = "3 day",
         n.levels = 3,
         cols = "viridis",
         proportion = "ws", date.breaks = 10,
         key.position = "top", key.columns = 3)
```

`timeProp` 的一个典型应用场景是作为聚类分析后的进一步分析手段。建议用户在进行 @sec-polarCluster 和 @sec-trajCluster-trajectory-analysis 中介绍的聚类分析后都尝试将产出的数据进一步使用 `timeProp` 绘制时序堆叠图。因为聚类分析结果已经为 `timeProp` 产出了现成的分类因子，如 cluster。
