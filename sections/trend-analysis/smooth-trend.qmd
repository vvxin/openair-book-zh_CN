---
author: David Carslaw
---

# 平滑趋势 Smooth trends {#sec-smoothTrend}

## 背景 {#sec-SmoothTrendInfo}

`smoothTrend` 函数用于计算污染物月均浓度的平滑趋势。缺省状态下，函数将生成月均浓度的变化曲线，同时在曲线上附加一条趋势线以及95%的置信度区间。平滑趋势线使用 [mgcv]{.pkg} 软件包中提供的广义可加模型（Generalized Additive Modelling）计算得到，该软件包提供了一整套全面和强大的建模方法，但是在这里我们需要的*建模*就是建立时间和污染物浓度之间的关系，即趋势。本函数所使用的方法优势在于优化平滑的程度，既不会因过于平滑而错过重要特征，也不会过于善变而放大“噪音”。关于在空气质量分析中使用这一方法的更多背景信息可以在 @Carslaw2007a 中找到。

@sec-trends-gam considers smooth trends in more detail and considers how different models can be developed that can be quite sophisticated. Readers should consider this section if they are considering trend analysis in more depth.

@sec-trends-gam 更详细的介绍了平滑趋势以及如何建立不同模型的过程。这些内容可能会逐渐变得非常复杂，如果读者有兴趣深入研究趋势分析的方方面面，建议参考本节。

用户将首先使用stl函数对数据进行季节特征的剔除，以更清晰地显示整体趋势。用户还可以选择使用自举模拟来建立趋势不确定性的另一种估计方法。此外，模拟的不确定性估计可以考虑使用块自举方法来处理残差中的自相关性。

## 趋势分析示例

我们使用以下的代码对 O~3~ 和 NO~2~ 进行了不同的趋势分析应用。@fig-smoothTrendComp 中的第一张图是原始 O~3~ 浓度的平滑趋势，显示出非常明显的季节周期特征。如第二张图表所示，通过剔除 O~3~ 的季节特征可以更好地解释整体趋势，去除季节特征对于季节特征较强的污染物（或站点）效果更好，例如臭氧和背景点位。第三张图是原始的NO~2~的平滑趋势，使用自举不确定性的情况。从这张图可以看到几乎没有季节周期特征。与Theil-Sen方法相比，平滑趋势方法的主要优势在这张图中也清楚可见。NO~2~浓度首先下降，然后急剧上升。因此，趋势不是单调的，这违反了Theil-Sen的假设。最后一张图显示了去季节特征后的效果：在这种情况下改进比较小。

```{r}
#| label: fig-smoothTrendComp
#| fig-cap: Examples of the `smoothTrend` function applied to Marylebone Road.'
#| fig-subcap: 
#|   - "Monthly mean O~3~."
#|   - "Deseasonalised O~3~."
#|   - "Monthly mean NO~2~ with bootstrap uncertainties."
#|   - "Deseasonalised monthly mean NO~2~ with bootstrap uncertainties."
#| fig-show: hold
#| fig-width: 6
#| fig-height: 5
#| layout-ncol: 2
library(openair) # load the package

smoothTrend(mydata, pollutant = "o3", ylab = "concentration (ppb)",
            main = "monthly mean o3")

smoothTrend(mydata, pollutant = "o3", deseason = TRUE, ylab = "concentration (ppb)",
            main = "monthly mean deseasonalised o3")

smoothTrend(mydata, pollutant = "no2", simulate = TRUE, ylab = "concentration (ppb)",
            main = "monthly mean no2 (bootstrap uncertainties)")

smoothTrend(mydata, pollutant = "no2", deseason = TRUE, simulate =TRUE,
            ylab = "concentration (ppb)",
            main = "monthly mean deseasonalised no2 (bootstrap uncertainties)")
```

`TheilSen` 函数的很多用法在 `smoothTrend` 函数中同样适用。@fig-smoothwd 是根据不同风向区间应用平滑趋势的结果，代码如下：

```{r}
#| label: fig-smoothwd
#| fig-cap: Marylebone路交通环境点 O~3~ 的 `smoothTrend` 函数应用结果。阴影为 95% 置信区间。
#| fig-width: 10
#| fig-height: 12
smoothTrend(mydata, pollutant = "o3", deseason = TRUE,
             type = "wd")
```

`smoothTrend` 函数可以轻松的获得大量不同条件下的趋势信息。例如：NO~2~, O~3~ 和 PM~10~ 三种污染物在不同季节和不用风向条件下的趋势。有8个风向区间对应4个不同季节的32张趋势图会被一起绘制出来。在@fig-smoothwdSeason 中，我们同时选择了三种污染物和两个附加类型（季节和风向），同时我们还增加了时间标签的显示间隔来让这个图表看起来更清晰。我们可以类似的组合不同的污染物和类型条件来探索不同条件下的趋势变化。

```{r}
#| label: fig-smoothwdSeason
#| fig-cap: 三种污染物在不同风向和不同季节下的变化趋势。
#| fig-width: 14
#| fig-height: 12
smoothTrend(mydata, pollutant = c("no2", "pm10", "o3"), 
            type = c("wd", "season"),
            date.breaks = 3, lty = 0)
```

## 按季节聚合数据

如果要重点关注不同季节下的变化趋势，可将平均时间设置为“season”，并在每一个单独的面板中显示每个季节的趋势特征是很好的表现形式。@fig-smoothTrendSeason 中，首先导入了位于英格兰南海岸的 Lullington Heath站点的数据，然后按照季节绘制平滑趋势。可以看到在2012年后春季 O~3~ 浓度升高趋势最为明显，这主要是由于 NO~x~ 浓度的普遍下降。

```{r}
#| label: importLul
lh <- importUKAQ(site = "lh", year = 2000:2019)
```

```{r}
#| label: fig-smoothTrendSeason
#| fig-cap: Lullington Heath点位各季节的 O~3~ 变化趋势，每个季节单独展示。
#| fig-width: 6
#| fig-height: 5
smoothTrend(lh, pollutant = "o3",
            avg.time = "season",
            type = "season",
            date.breaks = 4)
```
